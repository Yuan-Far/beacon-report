{"version":3,"sources":["../index.ts","index.js"],"names":["Monitor","domain","reportData"],"mappings":"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","file":"demo.e31bb0bc.js","sourceRoot":"..","sourcesContent":["// const ERROR_LIST: [] = [];\n\n// const ADD_DATA: object = {};\n\n// window.Performance = Performance;\n\n// Performance.addError = function (err: IError) {\n//   err = {\n//     method: 'GET',\n//     n: 'js',\n//     message: err.message,\n//     data: {\n//       col: err.col,\n//       line: err.line,\n//       resUrl: err.resUrl\n//     }\n//   }\n//   ERROR_LIST.push(err)\n// }\n// Performance.addData = function (fn: Function) {\n//   fn && fn(ADD_DATA)\n// }\n\nclass PerformanceIext implements Performance {\n  navigation!: PerformanceNavigation;\n  onresourcetimingbufferfull!: ((this: Performance, ev: Event) => any) | null;\n  timeOrigin!: number;\n  timing!: PerformanceTiming;\n  clearMarks(markName?: string | undefined): void {\n    throw new Error(\"Method not implemented.\");\n  }\n  clearMeasures(measureName?: string | undefined): void {\n    throw new Error(\"Method not implemented.\");\n  }\n  clearResourceTimings(): void {\n    throw new Error(\"Method not implemented.\");\n  }\n  getEntries(): PerformanceEntryList {\n    throw new Error(\"Method not implemented.\");\n  }\n  getEntriesByName(name: string, type?: string | undefined): PerformanceEntryList {\n    throw new Error(\"Method not implemented.\");\n  }\n  getEntriesByType(type: string): PerformanceEntryList {\n    throw new Error(\"Method not implemented.\");\n  }\n  mark(markName: string): void {\n    throw new Error(\"Method not implemented.\");\n  }\n  measure(measureName: string, startMark?: string | undefined, endMark?: string | undefined): void {\n    throw new Error(\"Method not implemented.\");\n  }\n  now(): number {\n    throw new Error(\"Method not implemented.\");\n  }\n  setResourceTimingBufferSize(maxSize: number): void {\n    throw new Error(\"Method not implemented.\");\n  }\n  toJSON() {\n    throw new Error(\"Method not implemented.\");\n  }\n  addEventListener<K extends \"resourcetimingbufferfull\">(type: K, listener: (this: Performance, ev: PerformanceEventMap[K]) => any, options?: boolean | AddEventListenerOptions | undefined): void;\n  addEventListener(type: string, listener: EventListenerOrEventListenerObject, options?: boolean | AddEventListenerOptions | undefined): void;\n  addEventListener(type: any, listener: any, options?: any) {\n    throw new Error(\"Method not implemented.\");\n  }\n  removeEventListener<K extends \"resourcetimingbufferfull\">(type: K, listener: (this: Performance, ev: PerformanceEventMap[K]) => any, options?: boolean | EventListenerOptions | undefined): void;\n  removeEventListener(type: string, listener: EventListenerOrEventListenerObject, options?: boolean | EventListenerOptions | undefined): void;\n  removeEventListener(type: any, listener: any, options?: any) {\n    throw new Error(\"Method not implemented.\");\n  }\n  dispatchEvent(event: Event): boolean {\n    throw new Error(\"Method not implemented.\");\n  }\n}\n\nconst PERFORMANCE_REPORT: number = 1;\nconst REQUEST_REPORT: number = 2;\nconst ERROR_REPORT: number = 3;\n\nconst LAST_TIMESTAMP = new Date().setHours(23, 59, 59, 999);\nconst NOT_AJAX_ARR = ['fetch', 'xmlhttprequest'];\n\n/**\n * @desc new Monitor(opts, fn)\n */\nexport default class Monitor extends PerformanceIext {\n  options: any;\n  fn: Function;\n  initConf: {\n    // 资源列表\n    resourceList: object[];\n    // 页面信息\n    performance: {};\n    // 错误列表\n    errorList: object[];\n    // referrer 来源\n    lastURI: string;\n    // 当前页面\n    currentPage: string;\n  };\n  constructor(options: any, fn: Function) {\n    super();\n    this.options = options;\n    this.fn = fn;\n    this.initConf = {\n      // 资源列表\n      resourceList: [],\n      // 页面信息\n      performance: {},\n      // 错误列表\n      errorList: [],\n      // referrer 来源\n      lastURI: document.referrer && document.referrer !== location.href ? document.referrer : '',\n      // 当前页面\n      currentPage: ''\n    }\n  }\n\n  private getOptions() {\n    let opts = Object.assign({\n      // 上报地址\n      domain: 'XXXX',\n      // 脚本延迟上报时间\n      outTime: 300,\n      // ajax请求时需要过滤的url信息\n      filterUrl: [],\n      // 是否上报页面性能数据\n      isPage: true,\n      // 是否上报ajax性能数据\n      isAjax: true,\n      // 是否上报页面资源数据\n      isResource: true,\n      // 是否上报错误信息\n      isError: true,\n      // 提交参数\n      add: {},\n    }, this.options);\n\n    const initError = {\n      t: '',\n      n: 'js',\n      msg: '',\n      data: {}\n    }\n    return {\n      opts,\n      initError\n    }\n  }\n\n  private get params() {\n    return this.getOptions();\n  }\n\n  private error() {\n\n  }\n\n  // 页面性能信息\n  public performancePage() {\n    if (!window.performance) return;\n    const timing = performance.timing;\n    this.initConf = {\n      ...this.initConf,\n      performance: {\n        // dns 解析\n        dnsTiming: timing.domainLookupEnd - timing.domainLookupStart || 0,\n        // tcp 建立\n        tcpTiming: timing.connectEnd- timing.connectStart || 0,\n        // request\n        reqTiming: timing.responseEnd - timing.requestStart || 0,\n        // 白屏\n        whiteTiming: timing.responseStart - timing.navigationStart || 0,\n        // dom 渲染\n        domTiming: timing.domContentLoadedEventEnd - timing.domContentLoadedEventStart || 0,\n        // dom 解析耗时\n        domInteractive: timing.domComplete - timing.domInteractive || 0,\n        // onload\n        onloadTiming: timing.loadEventEnd- timing.loadEventStart || 0,\n        // ready\n        readyTiming: timing.fetchStart - timing.navigationStart || 0,\n      }\n    }\n  }\n  // 页面资源信息\n  public performanceSource() {\n    if (!window?.performance?.getEntries) return false;\n    const resources = window.performance.getEntriesByType('resource');\n    if (!resources || !resources?.length) return [];\n    const {\n      isAjax,\n      isResource\n    } = this.params.opts;\n    this.initConf = {\n      ...this.initConf,\n      resourceList: resources.map(item => {\n        if (!isAjax && (NOT_AJAX_ARR.includes(item.initiatorType))) return {};\n        if (!isResource && (item.initiatorType != 'xmlhttprequest' && item.initiatorType !== 'fetchrequest')) return {};\n        const midData = {\n          name: item.name,\n          type: item.entryType,\n          initiatorType: item.initiatorType,\n          nextHopPortocol: item.nextHopProtocol,\n          duration: item.duration.toFixed(2) || 0,\n          decodedBodySize: item.decodedBodySize || 0,\n        }\n        return midData;\n      })\n    }\n  }\n\n  // 上报\n  public reportData(reportType?: number) {\n    const {\n      isPage,\n      outTime\n    } = this.params.opts;\n    setTimeout(() => {\n      if (isPage) this.performancePage()\n      console.log(this.initConf);\n    }, outTime)\n  }\n}\n","import Monitor from '../index';\n\nnew Monitor({\n  domain: 'http://localhost:1234'\n}, () => {}).reportData()\n\n"]}